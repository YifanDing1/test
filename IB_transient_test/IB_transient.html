<!DOCTYPE html>

<!--Line judgment task-->

<html>
<head>
    <title>Line Judgments</title>
    <style>
        canvas {
            position: absolute;
            top: 0px;
            left: 0px;
            bottom: 0px;
            right: 0px;
            margin: 0 auto;
            cursor: none;
        }
        #crossDisplay {
            background-color: transparent;
            z-index: 0;
            margin: 0 auto;
        }
        #maskDisplay{
            background-color: transparent;
            z-index: 3;
            margin: 0 auto;
        }
        #fixDisplay {
            background-color: transparent;
            z-index: 1;
            margin: 0 auto;
        }
        #bgDisplay {
            background-color: transparent;
            z-index: 2;
            margin: 0 auto;
        }
        #trialScreen {
            font-family: 'Arial';
            font-size: 25px;
            display: none;
            margin: 0 auto;
            width: 800px;
            height:600px;
        }
        #endScreen {
            font-family: 'Arial';
            font-size: 20px;
            position:absolute;
            display: none;
            top: 200px;
            left: 0px;
            bottom: 0px;
            right: 0px;
            margin: 0 auto;
            width: 800px;
        }
        #instructionScreen {
            font-family: 'Arial';
            font-size: 25px;
            text-align: center;
            display: none;
            width: 800px;
            margin: 0 auto;
        }
        #fullAttentionInst {
            font-family: 'Arial';
            font-size: 25px;
            text-align: center;
            display: none;
            width: 900px;
            margin: 0 auto;
        }
        #debrief {
            font-family: 'Arial';
            font-size: 18px;
            text-align: center;
            display: none;
            width: 800px;
            margin: 0 auto;
        }
        #line_judgment, #IB_T_noticeCritical, #IB_T_lookingForUnexpectedObjectCritical, #IB_T_lookingForUnexpectedObjectDivided, #face_question,
        #square_notice1, #face_question1, #face_question_yes1,
        #playback_pre, #playback {
            position: absolute;
            display: none;
            top: 200px;
            left: 0px;
            bottom: 0px;
            right: 0px;
            width: 800px;
            height: 400px;
            margin: 0 auto
        }
        #face_question span[face-type]{
            margin: 10px;
        }
        #face_question1 span[face-type1]{
            margin: 10px;
        }
        #row1 {
            margin-bottom: 20px; /* Adjust as needed */
        }
        #row3 {
            margin-bottom: 20px; /* Adjust as needed */
        }
        #prior{
            position: absolute;
            display: none;
            top: 50px;
            left: 0px;
            bottom: 0px;
            right: 0px;
            width: 800px;
            height: 600px;
            margin: 0 auto
        }
        label > input {
            visibility: hidden; /* Makes input not-clickable */
            position: absolute;
        }
        label > input + img {
            cursor:pointer;
            border:3px solid transparent;
        }
        label > input:checked + img {
            border:3px solid #FF0000;
        }
        .nextButton {
            background-color: #C70039;
            font-size: 50px;
            width: 400px;
            padding: 15px;
            margin: 0 auto;
        }
        .nextButton:hover {
            background-color: #900C3F;
            cursor: pointer;
        }
        fieldset {
            border: 0px;
            font-family: "Arial", sans-serif;
            position: absolute;
            top: 0px;
            left: 0px;
            bottom: 0px;
            right:0px;
            width:500px;
            margin:0 auto;
        }
        form {
            position: absolute;
            top: 0px;
            left: 0px;
            bottom: 0px;
            right: 0px;
            width:800px;
            margin:0 auto;
        }
    </style>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

</head>
<body style="font-family:'Arial'">
<div id="line_judgment">
    <form id="line_judgment_task" name="line_judgment_task" align='center'><fieldset align='left' style="border:0 none;align-content: left">
        Which arm of the cross was longer?<br /><br />
        <input type="radio" name="line_judgment_ans" value="vert"/>The vertical ( | ) arm<br />
        <input type="radio" name="line_judgment_ans" value="horiz"/>The horizontal ( --- ) arm
        <br /><br /><br />
        <button type="button" id="submitButton" align='center' onclick="check_fields('line_judgment', 'line_judgment_task')">Continue</button>
        <p id="line_judgment_task_error_msg" style="color:red; font-weight:bold; text-align: center"></p>
    </fieldset>
    </form>
</div>
<div id="IB_T_noticeCritical">
    <form id="word_survey" name="word_survey" align='center'><fieldset align='left' style="border:0 none;">
        Did you notice an additional object during the last cross-judging trial that wasn't there the first three times?<br /><br />
        <input type="radio" name="IB_T_noticeCritical" value="Yes"/>Yes<br />
        <input type="radio" name="IB_T_noticeCritical" value="No"/>No
        <br /><br /><br />
        <button type="button" id="submitButton" align='center' onclick="check_fields('IB_T_noticeCritical', 'word_survey')">Continue</button>
        <p id="word_survey_error_msg" style="color:red; font-weight:bold; text-align: center"></p>
    </fieldset>
    </form>
</div>
<div id="IB_T_lookingForUnexpectedObjectCritical">
    <form id="lookFor_survey" name="lookFor_survey" align='center'><fieldset align='left' style="border:0 none;">
        When you were completing that last trial, were you devoting some of your attention to looking for an additional object? <br /><br />
        <input type="radio" name="IB_T_lookingForUnexpectedObjectCritical" value="No"/>No, I was focused on judging which line was longer and was not looking for an additional object <br/><br/>
        <input type="radio" name="IB_T_lookingForUnexpectedObjectCritical" value="Yes"/>Yes, I was looking for an additional object while also judging which line was longer
        <br /><br /><br />
        <button type="button" id="submitButton" align='center' onclick="check_fields('IB_T_lookingForUnexpectedObjectCritical', 'lookFor_survey')">Continue</button>
        <p id="lookFor_survey_error_msg" style="color:red; font-weight:bold; text-align: center"></p>
    </fieldset>
    </form>
</div>
<div id="face_question">
    <form id="face_survey" name="face_survey" align='center'><fieldset align='left' style="border:0 none;">
        There actually was an extra object. If you saw it, please select the object you saw. If you didn't see it, please guess. <br /><br class="faces_break_start" />
        <div id="row1" class="option-row"></div>
        <span face-type="cross">
            <input type="radio" name="face_question" value="cross" style="margin-left: 30px"/>
                <div class="face cross">
                    <svg height="100" width="100">
                        <line x1="50" y1="10" x2="50" y2="90" stroke="black" stroke-width="3"></line> <!-- Vertical line -->
                        <line x1="10" y1="50" x2="90" y2="50" stroke="black" stroke-width="3"></line> <!-- Horizontal line -->
                    </svg>
                </div>
        </span>
        <span face-type="X">
            <input type="radio" name="face_question" value="X" style="margin-left: 30px"/>
                <div class="face X">
                  <svg height="100" width="100">
                    <line x1="10" y1="10" x2="90" y2="90" stroke="black" stroke-width="3"></line> <!-- Diagonal line -->
                    <line x1="90" y1="10" x2="10" y2="90" stroke="black" stroke-width="3"></line> <!-- Diagonal line -->
                  </svg>
                </div>
        </span>
        <div id="row2" class="option-row"></div>
        <span face-type="L">
               <input type="radio" name="face_question" value="L" style="margin-left: 30px"/>
                <div class="face L">
                  <svg height="100" width="100">
                    <line x1="50" y1="10" x2="50" y2="90" stroke="black" stroke-width="3"></line> <!-- Vertical line -->
                    <line x1="48.5" y1="90" x2="90" y2="90" stroke="black" stroke-width="3"></line> <!-- Horizontal line -->
                  </svg>
                </div>
        </span>
        <span face-type="T">
            <input type="radio" name="face_question" value="T" style="margin-left: 30px"/>
                <div class="face T">
                  <svg height="100" width="100">
                    <line x1="10" y1="10" x2="90" y2="10" stroke="black" stroke-width="3"></line> <!-- Horizontal line -->
                    <line x1="50" y1="10" x2="50" y2="90" stroke="black" stroke-width="3"></line> <!-- Vertical line -->
                  </svg>
                </div>
        </span>
        <br /> <br /> <br />
        <button type="button" id="submitButton" align='center' onclick="check_fields('face_question', 'face_survey')">Continue</button>
        <p id="face_survey_error_msg" style="color:red; font-weight:bold; text-align: center"></p>
    </fieldset>
    </form>
</div>

<div id="square_notice1">
    <form id="square_survey" name="square_survey" align='center'><fieldset align='left' style="border:0 none;">
        Did you notice an additional object during the last cross-judging trial that wasn't there the first three times? <br /><br />
        <input type="radio" name="square_notice1" value="Yes"/>Yes<br />
        <input type="radio" name="square_notice1" value="No"/>No
        <br /><br /><br />
        <button type="button" id="submitButton" align='center' onclick="check_fields('square_notice1', 'square_survey')">Continue</button>
        <p id="square_survey_error_msg" style="color:red; font-weight:bold; text-align: center"></p>
    </fieldset>
    </form>
</div>
<div id="face_question_yes1">
    <form id="face_survey_yes1" name="face_survey_yes1" align='center'><fieldset align='left' style="border:0 none;">
        Describe what you saw: <br /><br />
        <input type="text" name="id_face_survey_yes1" id="id_face_survey_yes1" value="" style="width: 600px; height: 20px">
        <br /><br /><br />
        <button type="button" id="submitButton" align='center' onclick="check_fields('face_question_yes1', 'face_survey_yes1')">Continue</button>
        <p id="face_survey_yes1_error_msg" style="color:red; font-weight:bold; text-align: center"></p>
    </fieldset>
    </form>
</div>
<div id="face_question1">
    <form id="face_survey1" name="face_survey1" align='center'><fieldset align='left' style="border:0 none;">
        There actually was an extra object. If you saw it, please select the object you saw. If you didn't see it, please guess. <br /><br class="faces_break_start1" />
        <div id="row3" class="option-row"></div>
        <span face-type1="cross">
            <input type="radio" name="face_question1" value="cross" style="margin-left: 30px"/>
                <div class="face cross">
                    <svg height="100" width="100">
                        <line x1="50" y1="10" x2="50" y2="90" stroke="black" stroke-width="3"></line> <!-- Vertical line -->
                        <line x1="10" y1="50" x2="90" y2="50" stroke="black" stroke-width="3"></line> <!-- Horizontal line -->
                    </svg>
                </div>
        </span>
        <span face-type1="X">
            <input type="radio" name="face_question1" value="X" style="margin-left: 30px"/>
                <div class="face X">
                  <svg height="100" width="100">
                    <line x1="10" y1="10" x2="90" y2="90" stroke="black" stroke-width="3"></line> <!-- Diagonal line -->
                    <line x1="90" y1="10" x2="10" y2="90" stroke="black" stroke-width="3"></line> <!-- Diagonal line -->
                  </svg>
                </div>
        </span>
        <div id="row4" class="option-row"></div>
        <span face-type1="L">
            <input type="radio" name="face_question1" value="L" style="margin-left: 30px"/>
                <div class="face L">
                  <svg height="100" width="100">
                    <line x1="50" y1="10" x2="50" y2="90" stroke="black" stroke-width="3"></line> <!-- Vertical line -->
                    <line x1="48.5" y1="90" x2="90" y2="90" stroke="black" stroke-width="3"></line> <!-- Horizontal line -->
                  </svg>
                </div>
        </span>
        <span face-type1="T">
            <input type="radio" name="face_question1" value="T" style="margin-left: 30px"/>
                <div class="face T">
                  <svg height="100" width="100">
                    <line x1="10" y1="10" x2="90" y2="10" stroke="black" stroke-width="3"></line> <!-- Horizontal line -->
                    <line x1="50" y1="10" x2="50" y2="90" stroke="black" stroke-width="3"></line> <!-- Vertical line -->
                  </svg>
                </div>
        </span>
        <br /> <br /> <br />
        <button type="button" id="submitButton" align='center' onclick="check_fields('face_question1', 'face_survey1')">Continue</button>
        <p id="face_survey1_error_msg" style="color:red; font-weight:bold; text-align: center"></p>
    </fieldset>
    </form>
</div>
<div id="IB_T_lookingForUnexpectedObjectDivided">
    <form id="lookFor_survey" name="lookFor_survey" align='center'><fieldset align='left' style="border:0 none;">
        When you were completing that last trial, were you devoting some of your attention to looking for an additional object? <br /><br />
        <input type="radio" name="IB_T_lookingForUnexpectedObjectDivided" value="No"/>No, I was focused on judging which line was longer and was not looking for an additional object <br/><br/>
        <input type="radio" name="IB_T_lookingForUnexpectedObjectDivided" value="Yes"/>Yes, I was looking for an additional object while also judging which line was longer
        <br /><br /><br />
        <button type="button" id="submitButton" align='center' onclick="check_fields('IB_T_lookingForUnexpectedObjectDivided', 'lookFor_survey')">Continue</button>
        <p id="lookFor_survey_error_msg" style="color:red; font-weight:bold; text-align: center"></p>
    </fieldset>
    </form>
</div>
<div id="playback_pre">
    <form id="playback_pre_survey" name="playback_pre_survey" align='center'><fieldset align='left' style="border:0 none;">
        Did the animation play smoothly, with no obvious lagging or freezing? <br /><br />
        <input type="radio" name="playback_pre" value="Yes"/>Yes<br />
        <input type="radio" name="playback_pre" value="No"/>No
        <br /><br /><br />
        <button type="button" id="submitButton" align='center' onclick="check_fields('playback_pre', 'playback_pre_survey')">Continue</button>
        <p id="playback_pre_survey_error_msg" style="color:red; font-weight:bold; text-align: center"></p>
    </fieldset>
    </form>
</div>
<div id="playback">
    <form id="playback_survey" name="playback_survey" align='center'><fieldset align='left' style="border:0 none;">
        Please describe the playback issues you experienced: <br /><br />
        <input type="text" name="id_playback" id="id_playback" value="" style="width: 600px; height: 20px">
        <br /><br /><br />
        <button type="button" id="submitButton" align='center' onclick="check_fields('playback', 'playback_survey')">Continue</button>
        <p id="playback_survey_error_msg" style="color:red; font-weight:bold; text-align: center"></p>
    </fieldset>
    </form>
</div>
<div id="prior" style="display: none">
    <form id="prior_survey" name="prior_survey"align='center'><fieldset align='left'>
        Have you performed a similar task before, where you were asked to judge which arm of a cross was longer,
        and something unexpected appeared? If you have, please briefly describe it in the text box.
        Your answer will not affect your compensation for completing this study. <br/><br/>
        <input type="radio" name="id_prior" value="0"> No <br />
        <input type="radio" name="id_prior" value="1"> Yes <br />
        <input type="text" name="id_prior_text" id="id_prior_text" value="" style="width: 600px; height: 40px">
        <br /><br /><br />
        <button type="button" id="submitButton" onclick="check_fields('prior', 'prior_survey')">Continue</button>
        <p id="prior_survey_error_msg" style="color:red; font-weight:bold"></p>
    </fieldset>
    </form>
</div>
<div id="instructionScreen">
    <br /> <br /> <br />
    In this task, you will make a difficult judgment about an image.
    <br /> <br />
    A black dot will appear and you should focus your eyes on it. Shortly after that, a cross will flash briefly somewhere on screen.
    <br /><br />
    Your task will be to judge which arm of the cross (the top-to-bottom arm or the left-to-right arm) is longer.
    <br /><br />
    Do the best you can!
    <br /> <br />
    <div id="startButton" class="nextButton">Begin</div>
</div>
<div id="mobileDetected" style="display: none; font-size: 18">
    <br /> <br /> <br />
    We have detected a screen that is too small to run this experiment.
    <br /> <br />
    If you are on a mobile device, please re-load this page on a larger device.
</div>
<div id="trialScreen" width=800 height=600>
    <canvas id="crossDisplay" width=800 height=600 style="position:absolute"></canvas>
    <canvas id="fixDisplay" width=800 height=600 style="position:absolute"></canvas>
    <canvas id='bgDisplay' width=800 height=600 style="position:absolute;text-align:center"></canvas>
    <canvas id='maskDisplay' width=800 height=600 style="position:absolute;text-align:center"></canvas>
</div>
<div id="fullAttentionInst" align='center' style="display: none">
    <p id="thanks" style="font-family:arial;top:200px">
        <br /> <br /> <br />
        For this next (and final) trial, please again judge which arm of the cross is longer and concentrate on the dot in the center. <br /><br />
    </p>
    <div id="contButton" class="nextButton" onclick="store_data('fullAttentionInst')"> Continue </div>
</div>

<div id='debrief' style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
    <p style="font-family:arial">
        When you are ready, click 'Continue' to proceed to the next task.
    </p>
    <form id="data_form" name="data_form" action="data.php" method="post" style='position:relative'><fieldset>
        <img src="face_study_mask.png" id="maskimg" hidden>
        <input type="hidden" name="counter" value="">
        <input type="hidden" name="IB_T_start" value="">
        <input type="hidden" name="IB_T_end" value="">
        <input type="hidden" name="IB_T_duration" value="" />
        <input type="hidden" name="IB_T_durationCross" value="" />
        <input type="hidden" name="IB_T_durationMask" value="" />
        <input type="hidden" name="IB_T_crossDistanceFromFixation" value="" />
        <input type="hidden" name="IB_T_objectDistanceFromFixation" value="" />
        <input type="hidden" name="IB_T_1_crossLocation" value="" />
        <input type="hidden" name="IB_T_1_crossHor" value="" />
        <input type="hidden" name="IB_T_1_crossVert" value="" />
        <input type="hidden" name="IB_T_2_crossLocation" value="" />
        <input type="hidden" name="IB_T_2_crossHor" value="" />
        <input type="hidden" name="IB_T_2_crossVert" value="" />
        <input type="hidden" name="IB_T_3_crossLocation" value="" />
        <input type="hidden" name="IB_T_3_crossHor" value="" />
        <input type="hidden" name="IB_T_3_crossVert" value="" />
        <input type="hidden" name="IB_T_4_crossLocation" value="" />
        <input type="hidden" name="IB_T_4_crossHor" value="" />
        <input type="hidden" name="IB_T_4_crossVert" value="" />
        <input type="hidden" name="IB_T_5_crossLocation" value="" />
        <input type="hidden" name="IB_T_5_crossHor" value="" />
        <input type="hidden" name="IB_T_5_crossVert" value="" />
        <input type="hidden" name="IB_T_1_actual" value="" />
        <input type="hidden" name="IB_T_2_actual" value="" />
        <input type="hidden" name="IB_T_3_actual" value="" />
        <input type="hidden" name="IB_T_4_actual" value="" />
        <input type="hidden" name="IB_T_5_actual" value="" />
        <input type="hidden" name="IB_T_1_resp" value="" />
        <input type="hidden" name="IB_T_2_resp" value="" />
        <input type="hidden" name="IB_T_3_resp" value="" />
        <input type="hidden" name="IB_T_4_resp" value="" />
        <input type="hidden" name="IB_T_5_resp" value="" />
        <input type="hidden" name="IB_T_1_acc" value="" />
        <input type="hidden" name="IB_T_2_acc" value="" />
        <input type="hidden" name="IB_T_3_acc" value="" />
        <input type="hidden" name="IB_T_4_acc" value="" />
        <input type="hidden" name="IB_T_5_acc" value="" />
        <input type="hidden" name="IB_T_UnexpectedObject" value="" />
        <input type="hidden" name="IB_T_noticeCritical" value="" />
        <input type="hidden" name="IB_T_choiceCritical" value="" />
        <input type="hidden" name="IB_T_choiceArrayCritical" value="" />
        <input type="hidden" name="IB_T_lookingForUnexpectedObjectCritical" value="" />
        <input type="hidden" name="IB_T_lookingForUnexpectedObjectDivided" value="" />
        <input type="hidden" name="IB_T_noticeDivided" value="" />
        <input type="hidden" name="IB_T_choiceDivided" value="" />
        <input type="hidden" name="IB_T_choiceArrayDivided" value="" />
        <input type="hidden" name="IB_T_glitches" value="" />
        <input type="hidden" name="IB_T_glitchesDescription" value="" />
        <input type="hidden" name="IB_T_taskFamiliar" value="" />
        <input type="hidden" name="IB_T_taskFamiliarDescription" value="" />
        <input type="submit" id="submit" value='Continue'>
    </fieldset>
    </form>
</div>

<style class="faces_style">
    .face {
        display: inline-block;
    }
</style>

<div class="svg_images" hidden>

    <div class="face cross">
        <svg height="100" width="100">
            <line x1="50" y1="10" x2="50" y2="90" stroke="black" stroke-width="3"></line> <!-- Vertical line -->
            <line x1="10" y1="50" x2="90" y2="50" stroke="black" stroke-width="3"></line> <!-- Horizontal line -->
        </svg>
    </div>

    <div class="face X">
        <svg height="100" width="100">
            <line x1="10" y1="10" x2="90" y2="90" stroke="black" stroke-width="3"></line> <!-- Diagonal line -->
            <line x1="90" y1="10" x2="10" y2="90" stroke="black" stroke-width="3"></line> <!-- Diagonal line -->
        </svg>
    </div>

    <div class="face L">
        <svg height="100" width="100">
            <line x1="50" y1="10" x2="50" y2="90" stroke="black" stroke-width="3"></line> <!-- Vertical line -->
            <line x1="48.5" y1="90" x2="90" y2="90" stroke="black" stroke-width="3"></line> <!-- Horizontal line -->
        </svg>
    </div>

    <div class="face T">
        <svg height="100" width="100">
            <line x1="10" y1="10" x2="90" y2="10" stroke="black" stroke-width="3"></line> <!-- Horizontal line -->
            <line x1="50" y1="10" x2="50" y2="90" stroke="black" stroke-width="3"></line> <!-- Vertical line -->
        </svg>
    </div>
</div>

<script>
    //global parameters documentation
    function getCounterFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('counter'); // Will return null if 'counter' is not in the URL
    }

    // Retrieve the counter value
    const counterValue = getCounterFromUrl();
    console.log("Counter value from URL:", counterValue);
    document.data_form.counter.value = counterValue;
    Day = formatDate(new Date());
    document.data_form.IB_T_start.value = Day;
    TimeStart = new Date();
    //Randomize IB type
    var ib_list = [
        'cross',
        'X',
        'L',
        'T'
    ]
    var face = shuffle(ib_list)[0]
    document.data_form.IB_T_UnexpectedObject.value = face;
    console.log('IB_T_UnexpectedObject', face);
    function run() {

        function Trial() {
            this.init = function() {
                this.trialOver = false;
                this.trialScreen = document.getElementById("trialScreen");
                if (trialsCompleted == 0) {
                    this.instructionScreen = document.getElementById("instructionScreen");
                }
                fixCanvas = document.getElementById("fixDisplay");
                crossCanvas = document.getElementById("crossDisplay");
                maskCanvas = document.getElementById("maskDisplay");
                bgCanvas = document.getElementById("bgDisplay");
                return true;
            }

            this.start = function() {
                cross_loc = Math.floor(Math.random()*4);

                if (trialsCompleted == 0) {
                    this.instructionScreen.style.display = "none";
                }
                this.trialScreen.style.display = "block";
                this.fixDur = 1500;
                //document.data_form.fixDur.value = this.fixDur;
                this.displayDur = 200;
                document.data_form.IB_T_durationCross.value = this.displayDur;
                this.maskDur = 500;
                document.data_form.IB_T_durationMask.value = this.maskDur;

                drawFixation();
                drawBorder();
                setTimeout(clearDisplay, this.fixDur + this.displayDur + this.maskDur, bgCanvas);
                if (trialParams[trialsCompleted] == 'cross') {
                    setTimeout(clearDisplay, this.fixDur, fixCanvas);
                    setTimeout(drawCross, this.fixDur, cross_loc);
                    setTimeout(clearDisplay, this.fixDur + this.displayDur, crossCanvas);
                    setTimeout(drawMask, this.fixDur + this.displayDur);
                }
                else if (trialParams[trialsCompleted] == 'ib') {
                    setTimeout(clearDisplay, this.fixDur, fixCanvas);
                    setTimeout(drawSquare, this.fixDur, cross_loc);
                    setTimeout(clearDisplay, this.fixDur + this.displayDur, crossCanvas);
                    setTimeout(drawMask, this.fixDur + this.displayDur);
                }
                setTimeout(clearDisplay, this.fixDur + this.displayDur, crossCanvas);
                setTimeout(clearDisplay, this.fixDur + this.displayDur, fixCanvas);
                setTimeout(clearDisplay, this.fixDur + this.displayDur + this.maskDur, maskCanvas);
                setTimeout(this.end, this.fixDur + this.displayDur + this.maskDur);
            }
            this.end = function() {
                if (trialsCompleted < 4) {
                    document.getElementById("trialScreen").style.display = 'none';
                    document.getElementById("line_judgment").style.display = 'block';
                    document.getElementById("line_judgment").style.visibility = 'visible';
                } else if (trialsCompleted == 4) {
                    document.getElementById("trialScreen").style.display = 'none';
                    document.getElementById("line_judgment").style.display = 'block';
                    document.getElementById("line_judgment").style.visibility = 'visible';
                }
            }
        } //end of trial class

        //////// PRIMARY FUNCTIONS ////////

        function init() {
            trial = new Trial;
            if (trial.init()) {
                if (trialsCompleted == 0) {
                    trial.instructionScreen.style.display = "block";
                    document.getElementById("startButton").onclick = function() {trial.start()};
                } else {
                    trial.start();
                }
            }
        }

        init();

    } //end of function run()

    function getRandomList(n, min, max) {
        for (var a=[],i=0;i<max;++i) a[i]=i;
        // http://stackoverflow.com/questions/962802#962890
        function shuffle(array) {
            var tmp, current, top = array.length;
            if(top) while(--top) {
                current = Math.floor(Math.random() * (top + 1));
                tmp = array[current];
                array[current] = array[top];
                array[top] = tmp;
            }
            return array;
        }

        return shuffle(a).slice(0, n);
    }

    /**
     * Randomize array element order in-place.
     * Using Durstenfeld shuffle algorithm.
     */
    function shuffle(array) {
        for (var i = array.length - 1; i > 0; i--) {
            var j = Math.floor(Math.random() * (i + 1));
            var temp = array[i];
            array[i] = array[j];
            array[j] = temp;
        }
        return array;
    }

    function getRadioValue(name) {
        var group = document.getElementsByName(name);
        for (var i=0;i<group.length;i++) {
            if (group[i].checked) {
                return group[i].value;
            }
        }
        return '';
    }

    function padTo2Digits(num) {
        return num.toString().padStart(2, '0');
    }
    function formatDate(date) {
        return (
            [
                date.getUTCFullYear(),
                padTo2Digits(date.getUTCMonth() + 1),
                padTo2Digits(date.getUTCDate()),
            ].join('/') +
            ' ' +
            [
                padTo2Digits(date.getUTCHours()),
                padTo2Digits(date.getUTCMinutes()),
                padTo2Digits(date.getUTCSeconds()),
            ].join(':')
        );
    }

    function check_fields(div_id, form_name) {
        var error_count = 0;
        var form = document.getElementById(form_name);
        for (i=0; i<form.elements.length; i++) {
            if (((form.elements[i].value == "") ||
                    (form.elements[i].value == null)) &&
                ((form.elements[i].type != "button") &&
                    (form.elements[i].type != "fieldset") &&
                    (form.elements[i].type != undefined) &&
                    (form.elements[i].type != "text") &&
                    (form.elements[i].type != "hidden"))) {
                error_count++;
            }
            if (form.elements[i].type == "radio") {
                var radioChecked = false;
                var radios = document.getElementsByName(form.elements[i].name);
                for (r=0; r<radios.length; r++) {
                    if (radios[r].checked) {
                        radioChecked = true;
                    }
                }
                if (!radioChecked) {
                    error_count++;
                }
            }
            if (form.elements[i].type == 'text' & div_id != 'prior') {
                if (form.elements[i].value.length < 1) {
                    error_count++;
                }
            }
            if (form.elements[i].value == "NA") {
                error_count++;
            }
        }
        if (error_count >= 1) {
            document.getElementById(form_name+"_error_msg").innerHTML = "One or" +
                " more questions are unanswered. Please answer these" +
                " questions and then click continue.";
        } else {
            document.getElementById(form_name+"_error_msg").innerHTML = "";
            store_data(div_id);
        }
    }
    function face_fn() {
        // Select all the span elements
        const faceElements = document.querySelectorAll('#face_question span[face-type]');
        const shuffledElements = shuffle(Array.from(faceElements));
        globalShuffledOrder = shuffledElements.map(el => el.getAttribute('face-type'));
        // Get row containers
        const row1 = document.getElementById('row1');
        const row2 = document.getElementById('row2');
        // Clear existing rows
        row1.innerHTML = '';
        row2.innerHTML = '';
        // Distribute the shuffled spans into rows
        shuffledElements.forEach((el, index) => {
            if (index < 2) {
                row1.appendChild(el);
            } else {
                row2.appendChild(el);
            }
        });
        // Record the order of the options
        const orderArray = [];
        document.querySelectorAll('#face_question .option-row span[face-type]').forEach(el => {
            orderArray.push(el.getAttribute('face-type'));
        });
        document.data_form.IB_T_choiceArrayCritical.value = orderArray;
        console.log('IB_T_choiceArrayCritical', orderArray);
    }

    function face_fn1() {
        // Select all the span elements
        const faceElements = document.querySelectorAll('#face_question1 span[face-type1]');
        const shuffledElements = shuffle(Array.from(faceElements));
        // Get row containers
        const row3 = document.getElementById('row3');
        const row4 = document.getElementById('row4');
        // Clear existing rows
        row3.innerHTML = '';
        row4.innerHTML = '';
        // Distribute the shuffled spans into rows
        shuffledElements.forEach((el, index) => {
            if (index < 2) {
                row3.appendChild(el);
            } else {
                row4.appendChild(el);
            }
        });
        // Record the order of the options
        const orderArray1 = [];
        document.querySelectorAll('#face_question1 .option-row span[face-type1]').forEach(el => {
            orderArray1.push(el.getAttribute('face-type1'));
        });
        document.data_form.IB_T_choiceArrayDivided.value = orderArray1;
        console.log('IB_T_choiceArrayDivided', orderArray1);
    }

    function store_data(div_id){
        if (div_id == 'line_judgment') {
            var options = document.getElementsByName("line_judgment_ans");
            for (var i=0;i<options.length;i++) { //TODO use this to capture responses and clear them at the same time
                if (options[i].checked) {
                    document.data_form['IB_T_' + (trialsCompleted + 1) + '_actual'].value = options[i].value;
                    document.data_form['IB_T_' + (trialsCompleted + 1) + '_resp'].value = last_line_longer;
                    document.data_form['IB_T_' + (trialsCompleted + 1) + '_acc'].value = options[i].value === last_line_longer ? 1 : 0;
                }
                options[i].checked = false;
            }
            document.getElementById("line_judgment").style.display = 'none';
            document.getElementById("line_judgment").style.visibility = 'hidden';
            trialsCompleted += 1;
            if (trialsCompleted < 4) {
                run();
            } else if (trialsCompleted == 4) {
                document.getElementById("IB_T_noticeCritical").style.display = 'block';
            } else {
                document.getElementById("square_notice1").style.display = 'block';
            }
        } else if (div_id == 'IB_T_noticeCritical') {
            document.data_form.IB_T_noticeCritical.value = getRadioValue('IB_T_noticeCritical');
            document.getElementById("IB_T_noticeCritical").style.display = 'none';
            face_fn();
            document.getElementById("face_question").style.display = 'block';
        } else if (div_id == 'face_question')  {
            document.data_form.IB_T_choiceCritical.value = getRadioValue('face_question');
            document.getElementById("face_question").style.display = 'none';
            document.getElementById("IB_T_lookingForUnexpectedObjectCritical").style.display = 'block';
        } else if (div_id == 'IB_T_lookingForUnexpectedObjectCritical') {
            document.data_form.IB_T_lookingForUnexpectedObjectCritical.value = getRadioValue('IB_T_lookingForUnexpectedObjectCritical');
            console.log('IB_T_lookingForUnexpectedObjectCritical: ', document.data_form.IB_T_lookingForUnexpectedObjectCritical.value)
            document.getElementById("IB_T_lookingForUnexpectedObjectCritical").style.display = 'none';
            document.getElementById("fullAttentionInst").style.display = 'block';
        } else if (div_id == 'fullAttentionInst') {
            document.getElementById("fullAttentionInst").style.display = 'none';
            run();
        } else if (div_id == 'square_notice1') {
            document.data_form.IB_T_noticeDivided.value = getRadioValue('square_notice1');
            document.getElementById("square_notice1").style.display = 'none';
            face_fn1();
            document.getElementById("face_question1").style.display = 'block';
        } else if (div_id == 'face_question1') {
            document.data_form.IB_T_choiceDivided.value = getRadioValue('face_question1');
            document.getElementById("face_question1").style.display = 'none';
            document.getElementById("IB_T_lookingForUnexpectedObjectDivided").style.display = 'block';
        } else if (div_id == 'IB_T_lookingForUnexpectedObjectDivided') {
            document.data_form.IB_T_lookingForUnexpectedObjectDivided.value = getRadioValue('IB_T_lookingForUnexpectedObjectDivided');
            console.log('IB_T_lookingForUnexpectedObjectDivided: ', document.data_form.IB_T_lookingForUnexpectedObjectDivided.value)
            document.getElementById("IB_T_lookingForUnexpectedObjectDivided").style.display = 'none';
            document.getElementById("debrief").style.display = 'block';

            //Record end time and calculate experiment duration
            DayEnd = formatDate(new Date());
            document.data_form.IB_T_end.value = DayEnd;
            TimeEnd = new Date();
            duration = Math.round((TimeEnd.getTime() - TimeStart.getTime())/1000);
            document.data_form.IB_T_duration.value = duration;
        }
    }


    function drawInlineSVG(svgElement, ctx, x1, y1) {
        var svgURL = new XMLSerializer().serializeToString(svgElement);
        var img = new Image();
        img.src = 'data:image/svg+xml; charset=utf8, ' + encodeURIComponent(svgURL);
        img.onload = function() {
            ctx.drawImage(this, x1, y1, 40, 40);
        }
    }


    function drawSquare(location) {

        var display = document.getElementById("crossDisplay");
        var context = display.getContext("2d");
        var thickness = 2;
        var lengths = [2.7*scale, 3.3*scale, 3.9*scale, 4.5*scale];
        var width = lengths[Math. floor(Math.random()*4)];
        lengths.splice(lengths.indexOf(width), 1);
        var height = lengths[Math. floor(Math.random()*3)];
        document.data_form['IB_T_' + (trialsCompleted + 1) + '_crossHor'].value = width;
        document.data_form['IB_T_' + (trialsCompleted + 1) + '_crossVert'].value = height;
        console.log("crossHor", document.data_form['IB_T_' + (trialsCompleted + 1) + '_crossHor'].value)
        console.log("crossVert", document.data_form['IB_T_' + (trialsCompleted + 1) + '_crossVert'].value)
        var offset = width - height;
        last_line_longer = width > height ? 'horiz' : 'vert';
        var cross_dist = 2*scale;
        document.data_form.IB_T_objectDistanceFromFixation.value = 0;
        var allpos = [[.5*display.width - cross_dist, .5*display.height - cross_dist], [.5*display.width + cross_dist, .5*display.height - cross_dist],
            [.5*display.width + cross_dist, .5*display.height + cross_dist], [.5*display.width - cross_dist, .5*display.height + cross_dist]]; //4 peripheral coordinates
        var pos = allpos[location];
        var x = pos[0];
        var y = pos[1];
        if (cross_loc == 0) {
            document.data_form['IB_T_' + (trialsCompleted + 1) + '_crossLocation'].value = 'UL ' + [x,y];
        } else if (cross_loc == 1) {
            document.data_form['IB_T_' + (trialsCompleted + 1) + '_crossLocation'].value = 'UR ' + [x,y];
        } else if (cross_loc == 2) {
            document.data_form['IB_T_' + (trialsCompleted + 1) + '_crossLocation'].value = 'LR ' + [x,y];
        } else if (cross_loc == 3) {
            document.data_form['IB_T_' + (trialsCompleted + 1) + '_crossLocation'].value = 'LL ' + [x,y];
        }
        console.log(document.data_form['IB_T_' + (trialsCompleted + 1) + '_crossLocation'].value);
        var [x1, y1] = [.5*display.width - 20, .5*display.height - 20];

        /////////////////
        var svgElement = document.querySelector(`.${face} svg`)
        drawInlineSVG(svgElement, context, x1, y1)
        /////////////////

        context.save();
        context.lineWidth = thickness;
        context.beginPath();
        context.moveTo(x - (.5*width), y);
        context.lineTo(x + (.5*width), y);
        context.stroke();
        context.beginPath();
        context.moveTo(x, y - (.5*height));
        context.lineTo(x, y + (.5*height));
        context.stroke();
        context.restore();
    }

    function drawCross(location) {

        var display = document.getElementById("crossDisplay");
        var context = display.getContext("2d");
        var thickness = 2;
        var lengths = [2.7*scale, 3.3*scale, 3.9*scale, 4.5*scale];
        var width = lengths[Math. floor(Math.random()*4)];
        lengths.splice(lengths.indexOf(width), 1);
        var height = lengths[Math. floor(Math.random()*3)];
        document.data_form['IB_T_' + (trialsCompleted + 1) + '_crossHor'].value = width;
        document.data_form['IB_T_' + (trialsCompleted + 1) + '_crossVert'].value = height;
        console.log("crossHor", document.data_form['IB_T_' + (trialsCompleted + 1) + '_crossHor'].value)
        console.log("crossVert", document.data_form['IB_T_' + (trialsCompleted + 1) + '_crossVert'].value)
        var offset = width - height;
        last_line_longer = width > height ? 'horiz' : 'vert';
        var cross_dist = 2*scale; // horizontal/vertical distance to the center of display
        document.data_form.IB_T_crossDistanceFromFixation.value = cross_dist;
        var allpos = [[.5*display.width - cross_dist, .5*display.height - cross_dist], [.5*display.width + cross_dist, .5*display.height - cross_dist],
            [.5*display.width + cross_dist, .5*display.height + cross_dist], [.5*display.width - cross_dist, .5*display.height + cross_dist]]; //4 peripheral coordinates
        var pos = allpos[location];
        //var rnd_pos = pos[Math. floor(Math.random())]
        var x = pos[0];
        var y = pos[1];
        if (cross_loc == 0) {
            document.data_form['IB_T_' + (trialsCompleted + 1) + '_crossLocation'].value = 'UL ' + [x,y];
        } else if (cross_loc == 1) {
            document.data_form['IB_T_' + (trialsCompleted + 1) + '_crossLocation'].value = 'UR ' + [x,y];
        } else if (cross_loc == 2) {
            document.data_form['IB_T_' + (trialsCompleted + 1) + '_crossLocation'].value = 'LR ' + [x,y];
        } else if (cross_loc == 3) {
            document.data_form['IB_T_' + (trialsCompleted + 1) + '_crossLocation'].value = 'LL ' + [x,y];
        }
        console.log(document.data_form['IB_T_' + (trialsCompleted + 1) + '_crossLocation'].value);
        context.save();
        context.lineWidth = thickness;
        context.beginPath();
        context.moveTo(x - (.5*width), y);
        context.lineTo(x + (.5*width), y);
        context.stroke();
        context.beginPath();
        context.moveTo(x, y - (.5*height));
        context.lineTo(x, y + (.5*height));
        context.stroke();
        context.restore();
    } //end of lines class

    function drawFixation() {
        var display = document.getElementById("fixDisplay");
        var context = display.getContext("2d");
        var radius = 5;
        var x = .5*display.width;//half the canvas width
        var y = .5*display.height;
        context.save();
        context.fillStyle = 'black';
        context.beginPath();
        context.arc(x, y, radius, 0, (Math.PI*2), true);
        context.closePath();
        context.fill();
        context.restore();
    }; //end of fixation

    function drawMask() {
        var display = document.getElementById("maskDisplay");
        var context = display.getContext("2d");
        var radius = 5*scale;
        var x = .5*display.width;//half the canvas width
        var y = .5*display.height;
        context.save();
        var pattern = context.createPattern(maskimg, "repeat");
        context.fillStyle = pattern;
        context.beginPath();
        context.arc(x, y, radius, 0, (Math.PI*2), true);
        context.closePath();
        context.fill();
        context.restore();
    }

    function drawBorder() {
        var display = document.getElementById("bgDisplay");
        var context = display.getContext("2d");
        var radius = 5*scale;
        var x = .5*display.width;//half the canvas width
        var y = .5*display.height;
        var thickness = 3;
        context.save();
        context.strokeStyle = 'black';
        context.lineWidth = thickness;
        context.beginPath();
        context.arc(x, y, radius, 0, (Math.PI*2), true);
        context.closePath();
        context.stroke();
        context.restore();
    }

    function clearDisplay(canvas) {
        var context = canvas.getContext("2d");
        context.clearRect(0, 0, canvas.width, canvas.height);
    };

    function getQueryVariable(variable) {
        var query = window.location.search.substring(1);
        var vars = query.split("&");
        for (var i=0;i<vars.length;i++) {
            var pair = vars[i].split("=");
            if(pair[0] == variable) {
                return pair[1];
            }
        }
        return(false);
    }

    function get_condition() {
        document.getElementById('data_form').addEventListener('submit', function(event){
            event.preventDefault();

            var formData = new FormData(this);
            var object = {};
            formData.forEach(function(value, key){
                object[key] = value;
            });
            var json = JSON.stringify(object);
            console.log(object);

            var xhr = new XMLHttpRequest();
            xhr.open("POST", "data.php", true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    var response = JSON.parse(xhr.responseText);
                    console.log(response);
                    // Handle response here
                    window.location.href = 'http://localhost/prolific/task_index.html';
                }
            };
            xhr.send(json);
        });
    }

    function main() {
        setTimeout(function(){
            if ((screen.width < 480) || (screen.height < 480)) {
                var mobile = document.getElementById("mobileDetected");
                mobile.style.display = "block";
            } else {
                //get_condition(assign_condition);
                get_condition();
                trialParams = ['cross', 'cross', 'cross', 'ib', 'ib'];
                //trialParams = ['ib', 'ib'];
                trialsCompleted = 0;
                scale = 50; //pixels per degree; adjust here to adjust everywhere
                run();
            }
        }, 100);
    }

    main();

</script>
</body>
</html>
